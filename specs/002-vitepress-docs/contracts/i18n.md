# i18n Contract: VitePress Documentation Site

**Feature**: VitePress Documentation Site
**Date**: 2025-10-03
**Contract Type**: Internationalization (i18n)
**Status**: Draft

## Purpose

This contract defines the internationalization requirements for the Atrarium documentation site, ensuring content parity between English and Japanese versions.

## Supported Locales

### English (Default)
```yaml
code: en
label: English
lang: en-US
link: /en/
direction: ltr
```

### Japanese
```yaml
code: ja
label: 日本語
lang: ja-JP
link: /ja/
direction: ltr
```

## Content Parity Requirements

### File Structure Mirroring

**Rule**: Every English page MUST have a corresponding Japanese page with identical path structure.

#### Required Mappings

| English Path | Japanese Path | Status |
|--------------|---------------|--------|
| `en/index.md` | `ja/index.md` | Required |
| `en/guide/overview.md` | `ja/guide/overview.md` | Required |
| `en/guide/setup.md` | `ja/guide/setup.md` | Required |
| `en/guide/quickstart.md` | `ja/guide/quickstart.md` | Required |
| `en/architecture/system-design.md` | `ja/architecture/system-design.md` | Required |
| `en/architecture/database.md` | `ja/architecture/database.md` | Required |
| `en/architecture/api.md` | `ja/architecture/api.md` | Required |
| `en/reference/api-reference.md` | `ja/reference/api-reference.md` | Required |
| `en/reference/implementation.md` | `ja/reference/implementation.md` | Required |
| `en/reference/development-spec.md` | `ja/reference/development-spec.md` | Required |

### Frontmatter Parity

**Rule**: Frontmatter structure MUST match across locales. Only values may differ (translated).

#### English Frontmatter Example
```yaml
---
title: Project Overview
description: Introduction to Atrarium architecture and design philosophy
order: 1
---
```

#### Japanese Frontmatter Example
```yaml
---
title: プロジェクト概要
description: Atrariumのアーキテクチャと設計思想の紹介
order: 1
---
```

**Required Fields**:
- `title`: Page title (translated)
- `description`: Meta description (translated)
- `order`: Numeric order (identical across locales)

**Optional Fields**:
- `layout`: Page layout (identical if present)
- `sidebar`: Custom sidebar (identical structure if present)
- `prev`/`next`: Manual navigation (translated links)

### Navigation Parity

**Rule**: Navigation structure MUST be identical across locales.

```typescript
// Sidebar structure must match
enSidebar.length === jaSidebar.length // Same number of sections

enSidebar[i].items.length === jaSidebar[i].items.length // Same items per section

// Only text and links differ
enSidebar[i].items[j].text !== jaSidebar[i].items[j].text // Text translated
enSidebar[i].items[j].link.replace('/en/', '/ja/') === jaSidebar[i].items[j].link // Paths mirror
```

## Locale Switcher

### Behavior

1. **Language Detection**:
   - Default locale: English (`/en/`)
   - Detect from URL path: `/en/*` → English, `/ja/*` → Japanese
   - No browser language auto-detection (explicit user choice)

2. **Switching**:
   - Switcher in navbar (top-right corner)
   - Shows current locale label ("English" or "日本語")
   - Click to switch between locales
   - Preserves current page: `/en/guide/overview` → `/ja/guide/overview`

3. **Persistence**:
   - User's locale choice saved in localStorage
   - Applied on next visit (if page exists in that locale)
   - Falls back to English if target page missing (with warning)

### Configuration

```typescript
// .vitepress/config.ts
export default defineConfig({
  locales: {
    en: {
      label: 'English',
      lang: 'en-US',
      link: '/en/'
    },
    ja: {
      label: '日本語',
      lang: 'ja-JP',
      link: '/ja/'
    }
  }
})
```

## Translation Workflow

### Initial Migration (English Baseline)

1. Migrate existing docs to `docs-site/en/` (reorganized structure)
2. Validate all English pages render correctly
3. Verify navigation works for English locale

### Japanese Translation

1. **Manual Translation**:
   - Copy `en/` structure to `ja/` (preserve paths)
   - Translate markdown content (preserve formatting)
   - Translate frontmatter values (keep keys identical)
   - Update internal links to point to `/ja/*` paths

2. **Assets**:
   - Images: Use shared `/images/*` paths (no duplication)
   - Diagrams: Add Japanese text overlay if necessary (separate file)
   - Code samples: Keep in English (technical content)

3. **Quality Check**:
   - Run parity validation tests
   - Verify all links resolve
   - Check navigation structure matches

### Ongoing Maintenance

**Process**:
1. Update English page (`en/guide/overview.md`)
2. Mark Japanese page as outdated (frontmatter flag)
3. Translate changes to Japanese (`ja/guide/overview.md`)
4. Remove outdated flag

**Outdated Page Indicator**:
```yaml
---
title: 概要
outdated: true
outdatedSince: 2025-10-03
---

:::warning
このページは英語版に対して古い可能性があります。[最新の英語版を確認](/en/guide/overview)
:::
```

## Validation Rules

### File Parity Check

**Test**: All English pages have Japanese equivalents

```typescript
// tests/docs-site/i18n.test.ts
test('all English pages have Japanese translations', async () => {
  const enPages = await glob('docs-site/en/**/*.md')
  const jaPages = await glob('docs-site/ja/**/*.md')

  const enPaths = enPages.map(p => p.replace('/en/', '/'))
  const jaPaths = jaPages.map(p => p.replace('/ja/', '/'))

  expect(enPaths.sort()).toEqual(jaPaths.sort()) // Exact match
})
```

### Frontmatter Structure Check

**Test**: Frontmatter keys match across locales

```typescript
test('frontmatter structure matches across locales', async () => {
  const enPage = await readFile('docs-site/en/guide/overview.md')
  const jaPage = await readFile('docs-site/ja/guide/overview.md')

  const enFrontmatter = extractFrontmatter(enPage)
  const jaFrontmatter = extractFrontmatter(jaPage)

  expect(Object.keys(enFrontmatter).sort()).toEqual(Object.keys(jaFrontmatter).sort())
})
```

### Navigation Structure Check

**Test**: Sidebar structure identical

```typescript
test('sidebar structure is identical across locales', () => {
  const { sidebar: enSidebar } = enConfig.themeConfig
  const { sidebar: jaSidebar } = jaConfig.themeConfig

  // Same number of sections
  expect(enSidebar.length).toBe(jaSidebar.length)

  // Same structure (ignore text content)
  const enStructure = enSidebar.map(s => s.items.length)
  const jaStructure = jaSidebar.map(s => s.items.length)
  expect(enStructure).toEqual(jaStructure)
})
```

## Link Handling

### Internal Links

**Rule**: Links must respect locale boundaries

```markdown
<!-- English page (en/guide/overview.md) -->
See the [system design](/en/architecture/system-design) for details.

<!-- Japanese page (ja/guide/overview.md) -->
詳細は[システム設計](/ja/architecture/system-design)を参照してください。
```

**Validation**: No cross-locale links (no `/en/` links in Japanese pages)

### External Links

**Rule**: External links are shared (no translation needed)

```markdown
<!-- Same in both locales -->
See [AT Protocol documentation](https://atproto.com/docs) for details.
```

### Asset Links

**Rule**: Assets are locale-neutral (shared `/images/*` paths)

```markdown
<!-- English -->
![Architecture Diagram](/images/architecture/system-diagram.png)

<!-- Japanese -->
![アーキテクチャ図](/images/architecture/system-diagram.png)
```

If locale-specific image needed, use subfolder:
```markdown
<!-- English -->
![Setup Screenshot](/images/en/setup-screenshot.png)

<!-- Japanese -->
![セットアップ画面](/images/ja/setup-screenshot.png)
```

## Search Localization

### Locale-Specific Search

**Behavior**:
- Search scopes to current locale automatically
- English search only searches `/en/*` pages
- Japanese search only searches `/ja/*` pages
- No cross-locale search results

### Search UI Translation

```typescript
// .vitepress/config.ts (English)
themeConfig: {
  search: {
    provider: 'local',
    options: {
      locales: {
        en: {
          translations: {
            button: {
              buttonText: 'Search',
              buttonAriaLabel: 'Search documentation'
            },
            modal: {
              noResultsText: 'No results found',
              resetButtonTitle: 'Reset search',
              footer: {
                selectText: 'to select',
                navigateText: 'to navigate'
              }
            }
          }
        },
        ja: {
          translations: {
            button: {
              buttonText: '検索',
              buttonAriaLabel: 'ドキュメントを検索'
            },
            modal: {
              noResultsText: '結果が見つかりません',
              resetButtonTitle: '検索をリセット',
              footer: {
                selectText: '選択',
                navigateText: '移動'
              }
            }
          }
        }
      }
    }
  }
}
```

## Fallback Behavior

### Missing Translation

**Scenario**: User visits `/ja/new-page` but Japanese translation doesn't exist

**Behavior**:
1. Show 404 page in Japanese
2. Display message: "このページは日本語版がまだ存在しません"
3. Provide link to English version: "View English version"
4. Do NOT auto-redirect (user's explicit choice)

### Incomplete Translation

**Scenario**: Page exists but marked as outdated

**Behavior**:
1. Show page with warning banner (frontmatter `outdated: true`)
2. Warning text: "このページは最新の英語版に対して古い可能性があります"
3. Link to English version for latest information

## Acceptance Criteria

- [ ] All English pages (`en/**/*.md`) have Japanese equivalents (`ja/**/*.md`)
- [ ] File paths mirror exactly between locales
- [ ] Frontmatter structure matches (same keys, translated values)
- [ ] Navigation structure is identical (same sections, items, order)
- [ ] Internal links respect locale boundaries (no cross-locale links)
- [ ] Asset links use shared `/images/*` paths (or locale subfolders)
- [ ] Search scopes to current locale only
- [ ] Search UI text is translated for each locale
- [ ] Locale switcher preserves current page path
- [ ] Outdated pages show warning with link to English version

## Future Enhancements

- **Additional Locales**: Add Chinese (zh), Korean (ko) when needed
- **Translation Memory**: Use Crowdin or similar for translation management
- **Auto-detection**: Optionally detect browser language and suggest locale
- **Translation Status**: Dashboard showing translation completeness per page
- **Machine Translation**: Use DeepL API for initial draft (human review required)
